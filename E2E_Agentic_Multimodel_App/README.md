
# ğŸ’° Personal Expense Manager Agent using ADK, Gemini 2.5 Flash, and Firestore

**Course:** FA25: CMPE-297 Sec 49 - Special Topics


---

## ğŸ“‹ Project Overview

This repository contains a complete implementation of a Personal Expense Management Agent built with Google's Agent Development Kit (ADK) and Gemini 2.5 Flash. The project demonstrates a full-stack multimodal agentic application that can process receipt images, extract expense data, store information in Firestore with vector embeddings, and provide intelligent expense tracking and analysis capabilities.

**Key Features:**
- Multimodal receipt processing (text + image analysis)
- Automatic expense data extraction from receipt photos
- Vector-based semantic search using Firestore
- Natural language query interface
- Metadata-based filtering for expense analysis
- Cloud-native deployment on Google Cloud Run

## ğŸ“¹ Video Demonstration
[Walkthrough YouTube Video](https://youtu.be/aQ4HVGlfhZo)

## ğŸ”— Related Resources

**Codelab:** [Build and Deploy Your Personal Expense Manager Agent](https://codelabs.developers.google.com/personal-expense-assistant-multimodal-adk)

**Medium Articles:**
- [Going Multimodal with ADK - Part 1](https://medium.com/google-cloud/going-multimodal-with-agent-development-kit-personal-expense-assistant-with-gemini-2-5-480b031c7d5a)
- [Going Multimodal with ADK - Part 2](https://medium.com/google-cloud/going-multimodal-with-agent-development-kit-personal-expense-assistant-with-gemini-2-5-17626aaee9a2)

---

## ğŸ“‚ Project Structure

```
personal-expense-assistant-adk/
â”œâ”€â”€ expense_manager_agent/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ agent.py                      # Main ADK agent implementation
â”‚   â”œâ”€â”€ tools.py                      # Agent tools (store, search, retrieve)
â”‚   â”œâ”€â”€ callbacks.py                  # Image data optimization callbacks
â”‚   â”œâ”€â”€ task_prompt.md                # Agent instruction prompt
â”‚   â””â”€â”€ .env                          # Environment variables
â”œâ”€â”€ schema.py                         # Pydantic models for API
â”œâ”€â”€ utils.py                          # Utility functions (GCS, formatting)
â”œâ”€â”€ settings.py                       # Settings management
â”œâ”€â”€ settings.yaml                     # Configuration file
â”œâ”€â”€ logger.py                         # Logging configuration
â”œâ”€â”€ backend.py                        # FastAPI backend server
â”œâ”€â”€ frontend.py                       # Gradio frontend interface
â”œâ”€â”€ Dockerfile                        # Container definition
â”œâ”€â”€ supervisord.conf                  # Process management config
â”œâ”€â”€ pyproject.toml                    # Python dependencies
â”œâ”€â”€ uv.lock                           # Dependency lock file
â””â”€â”€ README.md                         # This file
```

---

## ğŸ—ï¸ Architecture Overview

### System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    User Interface (Gradio)                   â”‚
â”‚              Chat Interface + Image Upload                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Backend API (FastAPI)                       â”‚
â”‚              Request/Response Processing                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ADK Agent (Gemini 2.5 Flash)                    â”‚
â”‚  â€¢ Multimodal Processing (Text + Images)                    â”‚
â”‚  â€¢ Tool Orchestration                                        â”‚
â”‚  â€¢ Context Management                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Firestore  â”‚  â”‚ Google Cloudâ”‚  â”‚  Gemini API â”‚
â”‚  Database   â”‚  â”‚   Storage   â”‚  â”‚  Embedding  â”‚
â”‚  (Vector)   â”‚  â”‚  (Artifacts)â”‚  â”‚   Model     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Components

**1. Frontend (Gradio)**
- Interactive chat interface
- Image upload capability
- Real-time conversation display
- Session management

**2. Backend (FastAPI)**
- RESTful API endpoints
- Request validation with Pydantic
- Image processing and storage
- Response formatting

**3. ADK Agent (Gemini 2.5 Flash)**
- Multimodal understanding (text + images)
- Tool calling and orchestration
- Context-aware responses
- Thinking process with extended budget

**4. Agent Tools**
- `store_receipt_data`: Extract and store receipt information
- `get_receipt_data_by_image_id`: Retrieve stored receipt data
- `search_receipts_by_metadata_filter`: Filter by date/amount
- `search_relevant_receipts_by_natural_language_query`: Vector search

**5. Data Layer**
- **Firestore**: NoSQL database with vector search capabilities
- **Google Cloud Storage**: Image artifact storage
- **Text Embedding 004**: Generate embeddings for semantic search

### Multimodal Processing Flow

1. **Image Upload**: User uploads receipt photo through Gradio UI
2. **Artifact Storage**: Image stored in GCS with hash-based ID
3. **Agent Processing**: Gemini 2.5 Flash analyzes image content
4. **Data Extraction**: Store name, date, amount, items extracted
5. **Embedding Generation**: Text embedding created for semantic search
6. **Firestore Storage**: Structured data + vector stored in Firestore
7. **Response**: Confirmation sent back to user

---

## ï¿½ ï¸ System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                   USER                                       â”‚
â”‚                          (Web Browser Interface)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ HTTP Request (text + images)
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         GRADIO FRONTEND (Port 8080)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â€¢ Chat Interface                                                   â”‚    â”‚
â”‚  â”‚  â€¢ Image Upload Component                                           â”‚    â”‚
â”‚  â”‚  â€¢ Session Management                                               â”‚    â”‚
â”‚  â”‚  â€¢ Response Rendering                                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ POST /chat (ChatRequest)
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FASTAPI BACKEND (Port 8081)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â€¢ Request Validation (Pydantic)                                    â”‚    â”‚
â”‚  â”‚  â€¢ Image Processing & Base64 Encoding                              â”‚    â”‚
â”‚  â”‚  â€¢ Session/User ID Management                                       â”‚    â”‚
â”‚  â”‚  â€¢ Response Formatting                                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ format_user_request_to_adk_content()
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GOOGLE CLOUD STORAGE (GCS)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Artifact Service: Store/Retrieve Images                            â”‚    â”‚
â”‚  â”‚  â€¢ Hash-based Image IDs (SHA256)                                    â”‚    â”‚
â”‚  â”‚  â€¢ Deduplication Logic                                              â”‚    â”‚
â”‚  â”‚  â€¢ Bucket: personal-expense-{project-id}                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ ADK Content (text + inline_data)
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ADK AGENT (expense_manager_agent)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Agent Configuration:                                               â”‚    â”‚
â”‚  â”‚  â€¢ Model: gemini-2.5-flash (Vertex AI)                             â”‚    â”‚
â”‚  â”‚  â€¢ Planner: BuiltInPlanner (thinking_budget: 2048)                 â”‚    â”‚
â”‚  â”‚  â€¢ Callback: modify_image_data_in_history                          â”‚    â”‚
â”‚  â”‚  â€¢ Instruction: task_prompt.md                                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Agent Tools:                                                       â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚ 1. store_receipt_data()                                       â”‚  â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ Extract: store, date, amount, items, currency           â”‚  â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ Generate embedding (text-embedding-004)                 â”‚  â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ Store in Firestore with vector                          â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚ 2. get_receipt_data_by_image_id()                            â”‚  â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ Query by receipt_id (image hash)                        â”‚  â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ Return structured receipt data                          â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚ 3. search_receipts_by_metadata_filter()                      â”‚  â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ Filter: date range, amount range                        â”‚  â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ Composite Firestore queries                             â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚ 4. search_relevant_receipts_by_natural_language_query()      â”‚  â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ Generate query embedding                                â”‚  â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ Vector similarity search (Euclidean distance)           â”‚  â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ Return top K similar receipts                           â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                            â”‚
               â”‚ Tool Calls                 â”‚ Embedding API
               â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FIRESTORE DATABASE         â”‚  â”‚   VERTEX AI GEMINI API       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Collection:            â”‚  â”‚  â”‚  â”‚ â€¢ gemini-2.5-flash     â”‚  â”‚
â”‚  â”‚ personal-expense-      â”‚  â”‚  â”‚  â”‚   (Multimodal LLM)     â”‚  â”‚
â”‚  â”‚ assistant-receipts     â”‚  â”‚  â”‚  â”‚                        â”‚  â”‚
â”‚  â”‚                        â”‚  â”‚  â”‚  â”‚ â€¢ text-embedding-004   â”‚  â”‚
â”‚  â”‚ Document Fields:       â”‚  â”‚  â”‚  â”‚   (768 dimensions)     â”‚  â”‚
â”‚  â”‚ â€¢ receipt_id           â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚ â€¢ store_name           â”‚  â”‚  â”‚                              â”‚
â”‚  â”‚ â€¢ transaction_time     â”‚  â”‚  â”‚  Location: us-central1       â”‚
â”‚  â”‚ â€¢ total_amount         â”‚  â”‚  â”‚  Project: [GCLOUD_PROJECT]   â”‚
â”‚  â”‚ â€¢ currency             â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚ â€¢ purchased_items[]    â”‚  â”‚
â”‚  â”‚ â€¢ embedding (Vector)   â”‚  â”‚
â”‚  â”‚                        â”‚  â”‚
â”‚  â”‚ Indexes:               â”‚  â”‚
â”‚  â”‚ â€¢ Vector Search        â”‚  â”‚
â”‚  â”‚ â€¢ Metadata Filters     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚
â”‚  Features:                   â”‚
â”‚  â€¢ Vector Similarity Search  â”‚
â”‚  â€¢ Composite Queries         â”‚
â”‚  â€¢ Real-time Updates         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   DEPLOYMENT (Cloud Run)        â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚  â”‚ Supervisord:              â”‚  â”‚
                    â”‚  â”‚ â€¢ Backend (Port 8081)     â”‚  â”‚
                    â”‚  â”‚ â€¢ Frontend (Port 8080)    â”‚  â”‚
                    â”‚  â”‚ â€¢ Auto-restart enabled    â”‚  â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â”‚                                 â”‚
                    â”‚  Container: Python 3.12-slim    â”‚
                    â”‚  Package Manager: uv            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Detailed Data Flow Scenarios

**1. Receipt Upload & Storage Flow:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: User Interaction                                                 â”‚
â”‚ â€¢ User uploads receipt image (JPG/PNG) via Gradio chat interface        â”‚
â”‚ â€¢ Optional: User adds text description                                   â”‚
â”‚ â€¢ Gradio captures: image file, MIME type, session_id, user_id          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: Frontend Processing (frontend.py)                               â”‚
â”‚ â€¢ Convert image to Base64 encoding                                       â”‚
â”‚ â€¢ Create ChatRequest object (Pydantic validation)                        â”‚
â”‚ â€¢ POST request to http://localhost:8081/chat                            â”‚
â”‚ â€¢ Payload: {text, files: [{serialized_image, mime_type}], session_id}  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: Backend API Processing (backend.py)                             â”‚
â”‚ â€¢ Validate request with Pydantic schema                                  â”‚
â”‚ â€¢ Call: format_user_request_to_adk_content()                            â”‚
â”‚ â€¢ Decode Base64 â†’ binary image data                                      â”‚
â”‚ â€¢ Generate SHA256 hash (first 12 chars) â†’ image_id                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: GCS Artifact Storage (utils.py)                                 â”‚
â”‚ â€¢ Check if image_id exists in GCS (deduplication)                       â”‚
â”‚ â€¢ If new: artifact_service.save_artifact()                              â”‚
â”‚ â€¢ Store in: gs://personal-expense-{project}/artifacts/{image_id}        â”‚
â”‚ â€¢ Create placeholder: [IMAGE-ID {hash}]                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 5: ADK Agent Invocation (agent.py)                                 â”‚
â”‚ â€¢ Callback: modify_image_data_in_history() - optimize context           â”‚
â”‚ â€¢ Agent receives: types.Content(role="user", parts=[image, text])       â”‚
â”‚ â€¢ Gemini 2.5 Flash analyzes image with vision capabilities              â”‚
â”‚ â€¢ Agent decides to use: store_receipt_data() tool                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 6: Receipt Data Extraction (tools.py)                              â”‚
â”‚ â€¢ Extract from image:                                                    â”‚
â”‚   - store_name: "Starbucks Coffee"                                      â”‚
â”‚   - transaction_time: "2024-11-15T14:30:00.000000Z" (ISO format)       â”‚
â”‚   - total_amount: 45000.0                                               â”‚
â”‚   - currency: "IDR"                                                     â”‚
â”‚   - purchased_items: [{name: "Latte", price: 35000, quantity: 1}, ...] â”‚
â”‚ â€¢ Validate data format and types                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 7: Embedding Generation (tools.py)                                 â”‚
â”‚ â€¢ Create description string from all receipt fields                      â”‚
â”‚ â€¢ Call: GENAI_CLIENT.models.embed_content()                             â”‚
â”‚ â€¢ Model: text-embedding-004                                             â”‚
â”‚ â€¢ Output: 768-dimensional vector embedding                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 8: Firestore Storage (tools.py)                                    â”‚
â”‚ â€¢ Create document with fields:                                           â”‚
â”‚   {                                                                      â”‚
â”‚     receipt_id: "a1b2c3d4e5f6",                                         â”‚
â”‚     store_name: "Starbucks Coffee",                                     â”‚
â”‚     transaction_time: "2024-11-15T14:30:00.000000Z",                   â”‚
â”‚     total_amount: 45000.0,                                              â”‚
â”‚     currency: "IDR",                                                    â”‚
â”‚     purchased_items: [...],                                             â”‚
â”‚     embedding: Vector([0.123, -0.456, ...])  // 768 dimensions         â”‚
â”‚   }                                                                      â”‚
â”‚ â€¢ COLLECTION.add(doc) â†’ Firestore                                       â”‚
â”‚ â€¢ Automatic indexing for vector search                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 9: Response Generation                                             â”‚
â”‚ â€¢ Agent formats response in markdown:                                    â”‚
â”‚   # THINKING PROCESS                                                    â”‚
â”‚   [reasoning steps...]                                                  â”‚
â”‚                                                                          â”‚
â”‚   # FINAL RESPONSE                                                      â”‚
â”‚   Receipt stored successfully with ID: a1b2c3d4e5f6                    â”‚
â”‚   Store: Starbucks Coffee                                               â”‚
â”‚   Amount: IDR 45,000                                                    â”‚
â”‚   Date: Nov 15, 2024                                                    â”‚
â”‚ â€¢ Extract thinking_process and sanitize response                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 10: Display to User                                                â”‚
â”‚ â€¢ Backend returns ChatResponse (Pydantic)                               â”‚
â”‚ â€¢ Gradio renders markdown response                                      â”‚
â”‚ â€¢ User sees confirmation with extracted details                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**2. Metadata-Based Search Flow:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Query: "Show me all expenses from last week over 50,000 IDR"       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ADK Agent Processing:                                                    â”‚
â”‚ â€¢ Parse natural language query                                           â”‚
â”‚ â€¢ Extract parameters:                                                    â”‚
â”‚   - Time range: last week â†’ calculate start_time & end_time             â”‚
â”‚   - Amount filter: min_total_amount = 50000.0                           â”‚
â”‚ â€¢ Select tool: search_receipts_by_metadata_filter()                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Firestore Query Execution:                                              â”‚
â”‚ â€¢ Build composite filter:                                                â”‚
â”‚   And([                                                                  â”‚
â”‚     FieldFilter("transaction_time", ">=", "2024-11-10T00:00:00Z"),     â”‚
â”‚     FieldFilter("transaction_time", "<=", "2024-11-17T23:59:59Z"),     â”‚
â”‚     FieldFilter("total_amount", ">=", 50000.0)                          â”‚
â”‚   ])                                                                     â”‚
â”‚ â€¢ Execute query.stream()                                                 â”‚
â”‚ â€¢ Return matching documents                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Results Formatting & Response:                                          â”‚
â”‚ â€¢ Format each receipt with RECEIPT_DESC_FORMAT                          â”‚
â”‚ â€¢ Agent generates summary and insights                                   â”‚
â”‚ â€¢ Display: 3 receipts found, total: IDR 175,000                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**3. Semantic Vector Search Flow:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Query: "Find all my coffee purchases"                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ADK Agent Processing:                                                    â”‚
â”‚ â€¢ Recognize fuzzy/semantic query (not exact metadata)                   â”‚
â”‚ â€¢ Select tool: search_relevant_receipts_by_natural_language_query()     â”‚
â”‚ â€¢ Pass query_text: "coffee purchases"                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Query Embedding Generation:                                             â”‚
â”‚ â€¢ Call: GENAI_CLIENT.models.embed_content()                             â”‚
â”‚ â€¢ Input: "coffee purchases"                                             â”‚
â”‚ â€¢ Model: text-embedding-004                                             â”‚
â”‚ â€¢ Output: query_vector [768 dimensions]                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Firestore Vector Search:                                                â”‚
â”‚ â€¢ COLLECTION.find_nearest(                                              â”‚
â”‚     vector_field="embedding",                                           â”‚
â”‚     query_vector=Vector(query_embedding),                               â”‚
â”‚     distance_measure=DistanceMeasure.EUCLIDEAN,                         â”‚
â”‚     limit=5                                                             â”‚
â”‚   )                                                                      â”‚
â”‚ â€¢ Calculate Euclidean distance for all vectors                          â”‚
â”‚ â€¢ Return top 5 most similar receipts                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Post-Processing & Filtering:                                            â”‚
â”‚ â€¢ Agent reviews results for relevance                                    â”‚
â”‚ â€¢ Filters out false positives                                           â”‚
â”‚ â€¢ Matches: Starbucks, Coffee Bean, Cafe Latte                          â”‚
â”‚ â€¢ Excludes: Restaurant (had "coffee" in items but not main purchase)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Response with Context:                                                   â”‚
â”‚ â€¢ Display 4 coffee-related receipts                                      â”‚
â”‚ â€¢ Total spent on coffee: IDR 180,000                                    â”‚
â”‚ â€¢ Most frequent: Starbucks (3 visits)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**4. Image Retrieval Flow:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Query: "Show me the receipt image from Starbucks yesterday"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ADK Agent Processing:                                                    â”‚
â”‚ â€¢ Search for receipt (metadata or vector search)                        â”‚
â”‚ â€¢ Get receipt_id: "a1b2c3d4e5f6"                                        â”‚
â”‚ â€¢ User explicitly requested image file                                   â”‚
â”‚ â€¢ Format response with JSON attachment block                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Response with Attachment:                                               â”‚
â”‚ # FINAL RESPONSE                                                        â”‚
â”‚ Here's your Starbucks receipt from yesterday:                           â”‚
â”‚                                                                          â”‚
â”‚ ```json                                                                 â”‚
â”‚ {                                                                        â”‚
â”‚   "attachments": ["[IMAGE-ID a1b2c3d4e5f6]"]                           â”‚
â”‚ }                                                                        â”‚
â”‚ ```                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend Processing (utils.py):                                          â”‚
â”‚ â€¢ Extract attachment IDs from JSON block                                â”‚
â”‚ â€¢ For each ID: download_image_from_gcs()                                â”‚
â”‚ â€¢ artifact_service.load_artifact(filename=image_id)                     â”‚
â”‚ â€¢ Convert to Base64 for transmission                                    â”‚
â”‚ â€¢ Add to ChatResponse.attachments[]                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend Display:                                                        â”‚
â”‚ â€¢ Gradio receives ChatResponse with attachments                         â”‚
â”‚ â€¢ Decode Base64 â†’ display image in chat                                 â”‚
â”‚ â€¢ User sees original receipt photo                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Technical Implementation Details

**Image Processing Pipeline:**
```
Raw Image â†’ Base64 Encode â†’ SHA256 Hash â†’ GCS Upload â†’ Placeholder
    â†“
MIME Type Detection (image/jpeg, image/png)
    â†“
Gemini Vision API â†’ Text Extraction â†’ Structured Data
    â†“
Validation (ISO datetime, numeric amounts, item format)
```

**Embedding Pipeline:**
```
Receipt Data â†’ Format String â†’ text-embedding-004 â†’ 768D Vector
    â†“
Store in Firestore with Vector type
    â†“
Automatic indexing for similarity search
    â†“
Query: Euclidean distance calculation
```

**Conversation Context Management:**
```
History: [msg1, msg2, msg3, msg4, msg5, ...]
    â†“
Callback: modify_image_data_in_history()
    â†“
Keep full image data: Last 3 user messages only
    â†“
Older messages: Replace image with [IMAGE-ID hash] placeholder
    â†“
Reduces token usage while maintaining context
```

**Error Handling & Validation:**
```
Input Validation:
â”œâ”€â”€ Pydantic schema validation (ChatRequest)
â”œâ”€â”€ Image format check (MIME type)
â”œâ”€â”€ ISO datetime format validation
â”œâ”€â”€ Numeric type validation (amounts)
â””â”€â”€ Required fields check (store_name, total_amount)

Error Recovery:
â”œâ”€â”€ Duplicate detection (receipt already exists)
â”œâ”€â”€ GCS upload retry logic
â”œâ”€â”€ Firestore connection error handling
â”œâ”€â”€ Graceful degradation (tool call failures)
â””â”€â”€ User-friendly error messages
```

---

## ğŸ¯ Key Features

### 1. Multimodal Receipt Processing
- **Image Analysis**: Upload receipt photos for automatic processing
- **OCR Extraction**: Gemini 2.5 Flash extracts text from images
- **Structured Data**: Automatically identifies store, date, amount, items
- **Smart Storage**: Deduplication using hash-based image IDs

### 2. Intelligent Search Capabilities

**Metadata-Based Search:**
- Filter by date range (start/end time)
- Filter by amount range (min/max)
- Precise structured queries
- Fast retrieval

**Vector-Based Semantic Search:**
- Natural language queries ("coffee purchases", "grocery shopping")
- Context-aware matching
- Similarity-based ranking
- Handles fuzzy matching for store/item names

### 3. Conversation Memory Management
- Session-based conversation tracking
- Image data optimization (keeps last 3 user messages)
- Context preservation across interactions
- Efficient token usage

### 4. Cloud-Native Architecture
- **Firestore**: Scalable NoSQL database with vector search
- **Google Cloud Storage**: Reliable artifact storage
- **Vertex AI**: Managed Gemini API access
- **Cloud Run**: Serverless deployment

### 5. Agent Capabilities
- **Thinking Process**: Extended reasoning budget (2048 tokens)
- **Tool Orchestration**: Automatic tool selection and chaining
- **Error Handling**: Graceful failure recovery
- **Multi-language Support**: Responds in user's language

---

## ğŸ“‹ Implementation Guide

### Phase 1: Backend Setup

**Step 1: Environment Configuration**
- Install Python 3.10+
- Set up virtual environment
- Install ADK and dependencies
- Configure Google Cloud credentials
- Set up database connection

**Step 2: Database Setup**
- Install PostgreSQL
- Create database schema
- Set up vector database (Chroma)
- Run migrations
- Seed initial data

**Step 3: Agent Development**
- Create expense agent with ADK
- Implement multimodal tools
- Configure Gemini 2.0 model
- Set up receipt processing
- Integrate RAG retriever

**Step 4: API Development**
- Create FastAPI application
- Define API endpoints
- Implement authentication
- Add CORS middleware
- Set up error handling

### Phase 2: Frontend Development

**Step 1: React Setup**
- Initialize React app with TypeScript
- Install UI libraries (Material-UI/Tailwind)
- Set up routing
- Configure API client
- Set up state management

**Step 2: Component Development**
- Build chat interface
- Create receipt upload component
- Develop expense dashboard
- Implement expense list view
- Add analytics charts

**Step 3: Integration**
- Connect to backend API
- Implement real-time updates
- Add image upload functionality
- Handle multimodal responses
- Error handling and loading states

### Phase 3: RAG Implementation

**Step 1: Vector Store Setup**
- Initialize vector database
- Create embedding pipeline
- Index expense data
- Set up retrieval logic

**Step 2: RAG Integration**
- Connect agent to vector store
- Implement context retrieval
- Add relevance scoring
- Optimize query performance

### Phase 4: Deployment

**Step 1: Containerization**
- Create Dockerfiles
- Set up docker-compose
- Configure environment variables
- Test local deployment

**Step 2: Cloud Deployment**
- Deploy backend to Cloud Run
- Deploy frontend to Firebase/Vercel
- Set up Cloud SQL
- Configure secrets management

---

## ğŸš€ Usage Examples

### Example 1: Receipt Upload

**User Action:**
- Upload receipt photo via web interface

**Agent Processing:**
1. Receives image through multimodal API
2. Uses Gemini 2.0 vision to extract text
3. Identifies: amount, date, merchant, category
4. Stores in database
5. Returns structured expense data

**User Sees:**
- Extracted expense details
- Suggested category
- Confirmation prompt

### Example 2: Natural Language Query

**User:** "How much did I spend on groceries last month?"

**Agent Processing:**
1. Understands intent (spending query)
2. Retrieves relevant data from database
3. Uses RAG to find similar past queries
4. Calculates total
5. Generates natural response

**Response:** "You spent $450 on groceries last month, which is 15% more than the previous month."

### Example 3: Budget Analysis

**User:** "Am I on track with my budget?"

**Agent Processing:**
1. Retrieves current month expenses
2. Compares with budget limits
3. Uses RAG for historical patterns
4. Generates insights
5. Provides recommendations

**Response:** "You've spent 65% of your monthly budget with 10 days remaining. Based on your usual spending pattern, you're on track to stay within budget."

---

## ğŸ“ Key Technologies

### Backend Stack
- **Google ADK:** Agent framework
- **Gemini 2.0:** Multimodal LLM
- **FastAPI:** Web framework
- **PostgreSQL:** Relational database
- **Chroma/Pinecone:** Vector database
- **SQLAlchemy:** ORM
- **Pydantic:** Data validation

### Frontend Stack
- **React:** UI framework
- **TypeScript:** Type safety
- **Material-UI/Tailwind:** UI components
- **Axios:** HTTP client
- **Chart.js/Recharts:** Data visualization
- **React Query:** Data fetching

### Infrastructure
- **Docker:** Containerization
- **Google Cloud Run:** Backend hosting
- **Firebase/Vercel:** Frontend hosting
- **Cloud SQL:** Managed database
- **Secret Manager:** Credentials management

---

## ğŸ’¡ Best Practices

### Agent Design
- Clear tool definitions
- Proper error handling
- Context management
- Multimodal input validation
- Response formatting

### Database Design
- Normalized schema
- Proper indexing
- Foreign key constraints
- Migration management
- Backup strategy

### API Design
- RESTful conventions
- Proper status codes
- Request validation
- Rate limiting
- API documentation

### Frontend Design
- Component reusability
- State management
- Error boundaries
- Loading states
- Responsive design

### Security
- Authentication and authorization
- Input sanitization
- SQL injection prevention
- CORS configuration
- Environment variable management

---

## ğŸ› Troubleshooting

### Issue: Multimodal Processing Fails
**Solutions:**
- Verify Gemini API credentials
- Check image format and size
- Validate API quota limits
- Review error logs
- Test with sample images

### Issue: Database Connection Errors
**Solutions:**
- Verify connection string
- Check database is running
- Validate credentials
- Review firewall rules
- Test connection manually

### Issue: RAG Retrieval Poor Quality
**Solutions:**
- Improve embedding quality
- Adjust similarity threshold
- Increase indexed data
- Optimize query formulation
- Review vector dimensions

### Issue: Frontend-Backend Communication
**Solutions:**
- Check CORS configuration
- Verify API endpoints
- Review network requests
- Validate request/response format
- Check authentication tokens

---

## ğŸ”— Resources

### Official Documentation
- **Codelab:** https://codelabs.developers.google.com/personal-expense-assistant-multimodal-adk
- **ADK Documentation:** https://developers.google.com/adk
- **Gemini API:** https://ai.google.dev/docs

### Related Articles
- **Multimodal ADK Part 1:** https://medium.com/google-cloud/going-multimodal-with-agent-development-kit-personal-expense-assistant-with-gemini-2-5-480b031c7d5a
- **Multimodal ADK Part 2:** https://medium.com/google-cloud/going-multimodal-with-agent-development-kit-personal-expense-assistant-with-gemini-2-5-17626aaee9a2

### Additional Resources
- FastAPI: https://fastapi.tiangolo.com/
- React: https://react.dev/
- PostgreSQL: https://www.postgresql.org/docs/
- Chroma: https://docs.trychroma.com/

---

## ğŸ“¹ Video Demonstration

https://www.youtube.com/

### Video Requirements

Your video walkthrough should cover:

1. **Project Overview (3 min)**
   - Architecture explanation
   - Technology stack
   - Key features demonstration

2. **Backend Code Walkthrough (8 min)**
   - Agent implementation
   - Multimodal tools
   - RAG integration
   - Database models
   - API endpoints

3. **Frontend Code Walkthrough (6 min)**
   - Component structure
   - Chat interface
   - Receipt upload
   - Dashboard implementation
   - API integration

4. **Database Schema (3 min)**
   - Table structure
   - Relationships
   - Vector store setup
   - Migration process

5. **End-to-End Demonstration (10 min)**
   - User registration/login
   - Receipt upload and processing
   - Natural language queries
   - Dashboard analytics
   - RAG-powered insights
   - Error handling

**Total Duration:** 30 minutes

---

## âœ… Completion Checklist

### Backend
- [ ] ADK agent implemented
- [ ] Multimodal processing working (text + images)
- [ ] Receipt OCR functional
- [ ] Database models created
- [ ] PostgreSQL connected
- [ ] Vector database integrated
- [ ] RAG retrieval working
- [ ] API endpoints implemented
- [ ] Authentication added
- [ ] Error handling complete

### Frontend
- [ ] React app initialized
- [ ] Chat interface built
- [ ] Receipt upload component working
- [ ] Dashboard with analytics
- [ ] Expense list view
- [ ] API integration complete
- [ ] Responsive design
- [ ] Error handling
- [ ] Loading states

### Integration
- [ ] Frontend-backend communication working
- [ ] Multimodal input processing end-to-end
- [ ] Database persistence verified
- [ ] RAG providing relevant context
- [ ] Real-time updates functioning

### Deployment
- [ ] Docker containers created
- [ ] docker-compose working locally
- [ ] Environment variables configured
- [ ] Cloud deployment successful
- [ ] Database migrations applied

### Documentation
- [ ] README complete
- [ ] API documentation
- [ ] Setup instructions
- [ ] Architecture diagrams
- [ ] Code comments

### Video
- [ ] Code walkthrough recorded
- [ ] All components explained
- [ ] End-to-end demo shown
- [ ] Video uploaded to YouTube
- [ ] Link added to README

---

## ğŸ¯ Grading Criteria

- **Architecture & Design (20%)** - Full-stack structure, proper separation of concerns
- **Multimodal Capabilities (20%)** - Text and image processing working correctly
- **RAG Integration (15%)** - Vector database and retrieval functioning
- **Database Backend (15%)** - Proper schema, persistence, queries
- **Frontend Quality (15%)** - UI/UX, responsiveness, functionality
- **Code Quality (10%)** - Clean, documented, maintainable code
- **Video Walkthrough (5%)** - Clear explanation and demonstration

---

## ğŸš€ Quick Start

### Prerequisites
- Python 3.10+
- Node.js 18+
- PostgreSQL 14+
- Docker (optional)
- Google Cloud account

### Backend Setup

```bash
cd backend
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
```

Set up environment variables in `.env`

Run database migrations

Start backend server

### Frontend Setup

```bash
cd frontend
npm install
npm start
```

### Docker Setup

```bash
docker-compose up --build
```

Access application at http://localhost:3000

---

## ğŸ“Š Database Schema

### Tables

**users**
- id (primary key)
- email
- password_hash
- created_at

**expenses**
- id (primary key)
- user_id (foreign key)
- amount
- category
- merchant
- date
- description
- receipt_url
- created_at

**categories**
- id (primary key)
- name
- budget_limit
- user_id (foreign key)

**embeddings**
- id (primary key)
- expense_id (foreign key)
- vector
- metadata

---

## ğŸ” Security Considerations

- Store API keys in environment variables
- Use Secret Manager for production
- Implement JWT authentication
- Validate all user inputs
- Sanitize database queries
- Enable HTTPS in production
- Implement rate limiting
- Add CORS restrictions
- Encrypt sensitive data
- Regular security audits

---

## ğŸŒŸ Advanced Features (Optional)

- Voice input for expense entry
- Multi-currency support
- Recurring expense tracking
- Budget alerts and notifications
- Export to CSV/PDF
- Mobile app version
- Collaborative expense sharing
- Integration with bank APIs
- AI-powered budget recommendations
- Predictive spending analysis

---

**Last Updated:** November 2025
**Course:** CMPE-297 Special Topics
**Assignment:** Full Stack E2E Agentic Multimodal Application
**Due Date:** November 9, 2025

